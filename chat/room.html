<div class="row" style="height: calc(100% - 120px)">
	<div id="chat" class="half hglt pad scrly"></div>
	<aside id="aside" class="half umar">
		<div id="roominfo">
			<h1><span id="name">$name</span> <small><a id="edit">Edit</a></small></h1>
			<p id="desc">$desc</p>
		</div>
		<form id="editform" hidden="">
			<input id="nameedit" type="text" value="$name" class="large" />
			<textarea id="descedit" type="text" class="fullwidth">$rawdesc</textarea>
			<button>Submit</button>
		</form>
		<hr />
		<h2>Users:</h2>
		<ul id="users"></ul>
		<hr />
		<h2>Stars:</h2>
		<ul id="stars"></ul>
	</aside>
</div>
$textarea
<p id="ts" hidden="">You are viewing old messages. <a href="/chat/$id">Join room</a>.</p>
<script>
	var noPageOverflow = 420,
		hash = parseInt(location.hash.substr(1)),
		socket = new WebSocket('ws://' + location.hostname + ':81/chat/$id' + (!isNaN(hash) ? '/' + hash : '')),
		username = '$user',
		onBottom = true,
		state = 1,
		skipped,
		ta = document.getElementById('ta'),
		cont = document.getElementById('chat'),
		starwall = document.getElementById('stars'),
		lock = true,
		ctrls = document.createElement('div'),
		ctrlsStar = document.createElement('a'),
		ctrlsLink = document.createElement('a'),
		ctrlsEdit = document.createElement('a'),
		ctrlsDelete = document.createElement('a'),
		ctrlsUndelete = document.createElement('a'),
		ctrlsFlag = document.createElement('a'),
		source = {},
		editing = false,
		e;
	ctrls.classList.add('ctrls');
	ctrlsStar.textContent = '★';
	ctrlsStar.onclick = function() {
		socket.send(JSON.stringify({event: this.classList.contains('clkd') ? 'unstar' : 'star', id: parseInt(this.parentNode.parentNode.id)}));
		this.classList.toggle('clkd');
	};
	ctrlsLink.textContent = '#';
	ctrlsLink.onclick = function() {
		open('message/' + this.parentNode.parentNode.id);
	};
	ctrlsEdit.textContent = '✎';
	ctrlsEdit.onclick = function() {
		var msg = this.parentNode.parentNode;
		msg.classList.add('editing');
		cont.scrollTop = cont.scrollHeight - cont.offsetHeight + document.getElementById(msg.id).getBoundingClientRect().top - cont.getBoundingClientRect().top;
		ta.focus();
		ta.value = source[msg.id];
		ta.selectionStart = ta.selectionEnd = ta.value.length;
		editing = msg.id;
	};
	ctrlsDelete.textContent = '✕';
	ctrlsDelete.onclick = function() {
		socket.send(JSON.stringify({event: 'delete', id: parseInt(this.parentNode.parentNode.id)}));
	};
	ctrlsUndelete.textContent = '↑';
	ctrlsUndelete.onclick = function() {
		socket.send(JSON.stringify({event: 'undelete', id: parseInt(this.parentNode.parentNode.id)}));
	};
	ctrlsFlag.textContent = '⚑';
	ctrlsFlag.onclick = function() {
		
	};
	ctrls.appendChild(ctrlsStar);
	ctrls.appendChild(ctrlsLink);
	ctrls.appendChild(ctrlsEdit);
	ctrls.appendChild(ctrlsDelete);
	ctrls.appendChild(ctrlsUndelete);
	ctrls.appendChild(ctrlsFlag);
	cont.onscroll = function(e) {
		onBottom = cont.scrollTop + cont.offsetHeight >= cont.scrollHeight - 2;
	};
	setInterval(function() {
		if (!lock &amp;&amp; innerWidth >= 700 &amp;&amp; cont.children.length >= 92 &amp;&amp; skipped &amp;&amp; cont.scrollTop &lt; 180) {
			skipped = Math.max(0, skipped - 1);
			socket.send(JSON.stringify({event: 'req', skip: skipped}));
		}
	}, 20);
	setInterval(function() {
		if (!lock &amp;&amp; innerWidth >= 700 &amp;&amp; cont.children.length >= 92 &amp;&amp; skipped &amp;&amp; cont.scrollTop &lt; 720) {
			skipped = Math.max(0, skipped - 1);
			socket.send(JSON.stringify({event: 'req', skip: skipped}));
		}
	}, 200);
	setInterval(function() {
		if (!lock &amp;&amp; innerWidth >= 700 &amp;&amp; cont.children.length >= 92 &amp;&amp; skipped &amp;&amp; cont.scrollTop &lt; cont.scrollHeight / 2) {
			skipped = Math.max(0, skipped - 1);
			socket.send(JSON.stringify({event: 'req', skip: skipped}));
		}
	}, 400);
	addEventListener('resize', function() {
		if (onBottom) cont.scrollTop = cont.scrollHeight;
	});
	function statechange(nstate) {
		if (nstate == 1 &amp;&amp; ta.value) nstate = 2;
		if (state != nstate) {
			state = nstate;
			socket.send(JSON.stringify({event: 'statechange', state: state}));
		}
	}
	function inactive() {
		statechange(0);
	}
	function active() {
		clearTimeout(timeout);
		timeout = setTimeout(inactive, 10000);
		statechange(1);
	}
	if (ta) {
		var timeout = setTimeout(inactive, 10000);
		addEventListener('keyup', active);
		addEventListener('keydown', active);
		addEventListener('click', active);
		addEventListener('mousemove', active);
		addEventListener('touchstart', active);
		addEventListener('scroll', active);
		addEventListener('resize', active);
		cont.addEventListener('scroll', active);
	}
	socket.onmessage = function(e) {
		console.log(e.data);
		var data;
		try {
			data = JSON.parse(e.data);
		} catch(err) {
			console.log(err);
			return alert('JSON Error. Response was: ' + e.data);
		}
		if (data.event == 'init' || data.event == 'add') {
			source[data.id] = data.body;
			var div = document.createElement('div');
			div.classList.add('comment');
			if (data.deleted) div.classList.add('deleted');
			div.innerHTML = username ? markdown(data.body).replace(new RegExp('@' + username + '(\\W)', 'g'), '&lt;span class="mention">@' + username + '&lt;/span>$1') : markdown(data.body);
			if (data.event == 'init') {
				var imgs = div.getElementsByTagName('img'),
					i = imgs.length;
				while (i--) imgs[i].onload = function() {
					cont.scrollTop = cont.scrollHeight;
				};
			}
			var sig = document.createElement('span');
			sig.classList.add('c-sig');
			var starcount = document.createElement('span');
			starcount.classList.add('starcount');
			starcount.appendChild(document.createTextNode((starcount.dataset.count = data.stars || 0) + '★'));
			sig.appendChild(starcount);
			sig.appendChild(document.createTextNode(' -'));
			var user = document.createElement('a');
			user.href = '/user/' + data.user;
			user.appendChild(document.createTextNode(data.user));
			sig.appendChild(user);
			sig.appendChild(document.createTextNode(', '));
			var permalink = document.createElement('a');
			if (!data.time) data.time = new Date().getTime();
			permalink.appendChild(agot(data.time));
			permalink.href = '#' + (div.id = data.id);
			sig.appendChild(permalink);
			div.appendChild(sig);
			var tCtrls = ctrls.cloneNode(true);
			tCtrls.children[0].onclick = ctrlsStar.onclick;
			tCtrls.children[1].onclick = ctrlsLink.onclick;
			tCtrls.children[2].onclick = ctrlsEdit.onclick;
			tCtrls.children[3].onclick = ctrlsDelete.onclick;
			tCtrls.children[4].onclick = ctrlsUndelete.onclick;
			tCtrls.children[5].onclick = ctrlsFlag.onclick;
			if (username != data.user) {
				tCtrls.removeChild(tCtrls.children[2]);
				tCtrls.removeChild(tCtrls.children[2]);
				tCtrls.removeChild(tCtrls.children[2]);
			} else tCtrls.children[data.deleted ? 3 : 4].hidden = true;
			if (data.deleted) tCtrls.children[0].hidden = true;
			if (username) div.appendChild(tCtrls);
			if (data.before) {
				cont.insertBefore(div, cont.firstChild);
				cont.scrollTop += div.offsetHeight + 3;
			} else cont.appendChild(div);
			if (data.event == 'add') new Audio('/a/beep.mp3').play();
			if (onBottom &amp;&amp; !location.hash) cont.scrollTop = cont.scrollHeight;
			cont.onscroll();
		} else if (data.event == 'edit') {
			source[data.id] = data.body;
			var msg = document.getElementById(data.id),
				msgCsig = msg.getElementsByClassName('c-sig')[0],
				msgCtrls = msg.getElementsByClassName('ctrls')[0];
			msg.innerHTML = username ? markdown(data.body).replace(new RegExp('@' + username + '(\\W)', 'g'), '&lt;span class="mention">@' + username + '&lt;/span>$1') : markdown(data.body);
			msg.appendChild(msgCsig);
			msg.appendChild(msgCtrls);
		} else if (data.event == 'delete') {
			var msg = document.getElementById(data.id);
			if (!msg) return;
			if (msg.getElementsByClassName('c-sig')[0].getElementsByTagName('a')[0].textContent == username) msg.classList.add('deleted');
			else msg.hidden = true;
			var msgCtrls = msg.getElementsByClassName('ctrls')[0];
			if (!msgCtrls) return;
			msgCtrls = msgCtrls.children;
			msgCtrls[0].hidden = true;
			if (msgCtrls[3]) msgCtrls[3].hidden = true;
			if (msgCtrls[3]) msgCtrls[4].hidden = false;
		} else if (data.event == 'undelete') {
			var msg = document.getElementById(data.id);
			if (!msg) return;
			if (msg.getElementsByClassName('c-sig')[0].getElementsByTagName('a')[0].textContent == username) msg.classList.remove('deleted');
			else msg.hidden = false;
			var msgCtrls = msg.getElementsByClassName('ctrls')[0].children;
			if (!msgCtrls) return;
			msgCtrls = msgCtrls.children;
			msgCtrls[0].hidden = false;
			if (msgCtrls[3]) msgCtrls[3].hidden = false;
			if (msgCtrls[3]) msgCtrls[4].hidden = true;
		} else if (data.event == 'selfstar') {
			if (e = document.getElementById(data.id)) e.getElementsByClassName('ctrls')[0].firstChild.classList.add('clkd');
		} else if (data.event == 'star') {
			var f;
			if ((e = document.getElementById(data.id)) &amp;&amp; (f = document.getElementById(data.id + 's'))) {
				e = e.getElementsByClassName('starcount')[0];
				e.removeChild(e.firstChild);
				e.appendChild(document.createTextNode(++e.dataset.count + '★'));
				f = f.getElementsByClassName('starcount')[0];
				var g;
				while (g = f.firstChild) f.removeChild(g);
				f.appendChild(document.createTextNode(++f.dataset.count + '★ '));
			} else {
				var li = document.createElement('li'),
					div = document.createElement('div');
				e = document.getElementById(data.id);
				if (e &amp;&amp; !data.board) {
					e = e.getElementsByClassName('starcount')[0];
					e.removeChild(e.firstChild);
					e.appendChild(document.createTextNode(++e.dataset.count + '★'));
				}
				div.id = data.id + 's';
				div.classList.add('comment');
				div.innerHTML = username ? markdown(data.body).replace(new RegExp('@' + username + '(\\W)', 'g'), '&lt;span class="mention">@' + username + '&lt;/span>$1') : markdown(data.body);
				var sig = document.createElement('span');
				sig.classList.add('c-sig');
				var starcount = document.createElement('span');
				starcount.classList.add('starcount');
				starcount.appendChild(document.createTextNode((starcount.dataset.count = data.stars || 0) + '★'));
				sig.appendChild(starcount);
				sig.appendChild(document.createTextNode(' -'));
				var user = document.createElement('a');
				user.href = '/user/' + data.user;
				user.appendChild(document.createTextNode(data.user));
				sig.appendChild(user);
				sig.appendChild(document.createTextNode(', '));
				var permalink = document.createElement('a');
				if (!data.time) data.time = new Date().getTime();
				permalink.appendChild(agot(data.time));
				permalink.href = '#' + data.id;
				sig.appendChild(permalink);
				div.appendChild(sig);
				li.appendChild(div);
				if (starwall.firstChild) starwall.insertBefore(li, starwall.firstChild);
				else starwall.appendChild(li);
			}
		} else if (data.event == 'unstar') {
			var e;
			if (e = document.getElementById(data.id)) {
				e = e.getElementsByClassName('starcount')[0];
				e.removeChild(e.firstChild);
				var count = --e.dataset.count;
				e.appendChild(document.createTextNode(count + '★'));
			}
			if (e = document.getElementById(data.id + 's')) {
				if (count &lt; 1) return e.parentNode.parentNode.removeChild(e.parentNode);
				e = e.getElementsByClassName('starcount')[0];
				e.dataset.count--;
				var f;
				while (f = e.firstChild) e.removeChild(f);
				e.appendChild(document.createTextNode(count + '★ '));
			}
		} else if (data.event == 'adduser') {
			var li = document.createElement('li');
			if (data.state == 0) li.classList.add('inactive');
			if (data.state == 2) li.classList.add('writing');
			li.id = 'user-' + data.name;
			var a = document.createElement('a');
			a.appendChild(document.createTextNode(data.name));
			a.href = '/user/' + data.name;
			li.appendChild(a);
			document.getElementById('users').appendChild(li);
		} else if (data.event == 'deluser') {
			var li = document.getElementById('user-' + data.name);
			if (li) li.parentNode.removeChild(li);
		} else if (data.event == 'statechange') {
			var li = document.getElementById('user-' + data.user);
			if (!li) return;
			if (data.state == 0) li.classList.add('inactive');
			else li.classList.remove('inactive');
			if (data.state == 2) li.classList.add('writing');
			else li.classList.remove('writing');
		} else if (data.event == 'info-skipped') {
			skipped = data.body;
			if (data.ts) {
				ta.hidden = document.getElementById('btn').hidden = true;
				document.getElementById('ts').hidden = false;
			}
		} else if (data.event == 'info-complete') {
			lock = false;
			if (!isNaN(hash)) {
				location.hash = '';
				location.hash = '#' + hash;
			};
		} else if (data.event == 'info-update') {
			document.title = (document.getElementById('name').textContent = document.getElementById('nameedit').value = data.name) + ' | Chat | DevDoodle';
			document.getElementById('desc').textContent = document.getElementById('descedit').value = data.desc;
		} else if (data.event == 'err') {
			alert('Error: ' + data.body);
			if (data.revertInfo) {
				document.getElementById('nameedit').value = document.getElementById('name').textContent;
				document.getElementById('descedit').value = document.getElementById('desc').textContent;
			}
		}
	};
	socket.onclose = function() {
		if (confirm('Connection error. Reload?')) location.reload();
	};
	if (ta) ta.onkeypress = ta.onkeydown = function(e) {
		if (e.keyCode == 13 &amp;&amp; !e.shiftKey &amp;&amp; !e.metaKey) {
			e.preventDefault();
			if (editing) {
				socket.send(JSON.stringify({event: 'edit', body: ta.value, id: parseInt(editing)}));
				document.getElementsByClassName('editing')[0].classList.remove('editing');
				editing = false;
				this.value = '';
				cont.scrollTop = cont.scrollHeight;
			} else {
				socket.send(JSON.stringify({event: 'post', body: ta.value}));
				location.hash = '';
				ta.value = '';
				cont.scrollTop = cont.scrollHeight;
			};
		} else if (editing &amp;&amp; e.keyCode == 27 &amp;&amp; !e.metaKey) {
			e.preventDefault();
			document.getElementsByClassName('editing')[0].classList.remove('editing');
			editing = false;
			this.value = '';
			cont.scrollTop = cont.scrollHeight;
		} else if (e.keyCode == 38 &amp;&amp; !ta.value &amp;&amp; !e.shiftKey &amp;&amp; !e.metaKey) {
			e.preventDefault();
			var i = cont.children.length;
			while (i--) {
				if (cont.children[i].getElementsByClassName('c-sig')[0].getElementsByTagName('a')[0].textContent == username) {
					e = cont.children[i].getElementsByClassName('ctrls')[0].children[2];
					return e.onclick.apply(e);
				}
			}
		} else if (e.keyCode == 38 &amp;&amp; editing &amp;&amp; ta.value == source[editing] &amp;&amp; !e.shiftKey &amp;&amp; !e.metaKey) {
			e.preventDefault();
			var i = cont.children.indexOf(document.getElementById(editing));
			while (i--) {
				if (cont.children[i].getElementsByClassName('c-sig')[0].getElementsByTagName('a')[0].textContent == username) {
					editing = false;
					document.getElementsByClassName('editing')[0].classList.remove('editing');
					e = cont.children[i].getElementsByClassName('ctrls')[0].children[2];
					return e.onclick.apply(e);
				}
			}
		} else if (e.keyCode == 40 &amp;&amp; editing &amp;&amp; ta.value == source[editing] &amp;&amp; !e.shiftKey &amp;&amp; !e.metaKey) {
			e.preventDefault();
			var i = cont.children.indexOf(document.getElementById(editing));
			while (++i &lt; cont.children.length) {
				if (cont.children[i].getElementsByClassName('c-sig')[0].getElementsByTagName('a')[0].textContent == username) {
					editing = false;
					document.getElementsByClassName('editing')[0].classList.remove('editing');
					e = cont.children[i].getElementsByClassName('ctrls')[0].children[2];
					return e.onclick.apply(e);
				}
			}
			document.getElementsByClassName('editing')[0].classList.remove('editing');
			editing = false;
			this.value = '';
			cont.scrollTop = cont.scrollHeight;
		}
	};
	var edit = document.getElementById('edit');
	if (edit) {
		edit.onclick = function() {
			document.getElementById('roominfo').hidden = true;
			document.getElementById('editform').hidden = false;
		};
	}
	document.getElementById('editform').onsubmit = function() {
		document.getElementById('roominfo').hidden = false;
		document.getElementById('editform').hidden = true;
		socket.send(JSON.stringify({event: 'info-update', name: document.getElementById('nameedit').value, desc: document.getElementById('descedit').value}));
		return false;
	};
	var hashchangeready = false;
	addEventListener('hashchange', function(e) {
		if (hashchangeready) {
			var hash = e.newURL.split('#', 2)[1];
			if (hash &amp;&amp; !document.getElementById(hash)) location.reload();
		} else haschangeready = true;
	});
</script>
<style>
	#chat {
		height: 100%;
		overflow-x: hidden;
	}
	#chat img { height: 300px }
	@media (max-width: 600px) {
		#chat img { height: 150px }
	}
	@media (max-width: 400px) {
		#chat img { height: 50px }
	}
	.comment:hover { outline: 1px dotted #000 }
	.ctrls { border: 1px solid #aaa }
	.starcount {
		font-weight: bold;
		color: #d60;
		line-height: 1.2;
	}
	.starcount[data-count="0"] { display: none }
	.inactive {
		color: red;
		font-style: italic;
	}
	.writing {
		color: green;
		font-weight: bold;
	}
	#stars {
		list-style-type: none;
		padding: 0;
	}
	#stars li { margin: 4px 0 }
	#editform { margin: 0 }
	#users a { font-weight: normal }
	#users:empty::after { content: 'No users in room' }
	#stars:empty::after { content: 'No starred messages' }
	.comment:not(:hover) .ctrls:not(:hover) { display: none }
	@media (max-width: 699px) {
		#chat { width: 100% }
		#aside { display: none }
	}
	@media (min-width: 700px) {
		#chat { width: 80% }
		#aside { width: 19.5% }
	}
	.mention {
		background: #faa;
		border-radius: 4px;
	}
	.editing { background: #4af }
	.deleted { background: #f00 }
</style>