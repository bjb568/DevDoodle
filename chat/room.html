<div class="row" style="height: calc(100% - 120px)">
	<div id="chat" class="half hglt pad pre scrly"></div>
	<aside id="aside" class="half umar">
		<div id="roominfo">
			<h1><span id="name">$name</span> <small><a id="edit">Edit</a></small></h1>
			<p id="desc">$desc</p>
		</div>
		<form id="editform" hidden="">
			<input id="nameedit" type="text" value="$name" class="large" />
			<textarea id="descedit" type="text" class="fullwidth">$desc</textarea>
			<button>Submit</button>
		</form>
		<hr />
		<h2>Users:</h2>
		<ul id="users"></ul>
		<hr />
		<h2>Stars:</h2>
		<ul id="stars"></ul>
	</aside>
</div>
<textarea autofocus="" id="ta" class="umar" style="width: 100%; height: 96px;"></textarea><button id="btn" class="blk" onclick="send()">Post</button>
<p id="ts" hidden="">You are viewing old messages. <a href="/chat/$id">Join room</a>.</p>
<script>
	var noPageOverflow = 420,
		hash = parseInt(location.hash.substr(1)),
		socket = new WebSocket('ws://' + location.hostname + ':81/chat/$id' + (!isNaN(hash) ? '/' + hash : '')),
		user = document.getElementById('nav').childNodes[13].textContent,
		onBottom = true,
		state = 1,
		skipped,
		cont = document.getElementById('chat'),
		lock = true,
		ctrls = document.createElement('div'),
		ctrlsDelete = document.createElement('a'),
		ctrlsFlag = document.createElement('a'),
		ctrlsStar = document.createElement('a'),
		e;
	if (user == 'Login') user = false;
	ctrls.classList.add('ctrls');
	ctrlsStar.textContent = '★';
	ctrlsStar.onclick = function() {
		socket.send(JSON.stringify({event: this.classList.contains('clkd') ? 'unstar' : 'star', id: parseInt(this.parentNode.parentNode.id)}));
		this.classList.toggle('clkd');
	};
	ctrlsDelete.textContent = '✕';
	ctrlsDelete.onclick = function() {
		
	};
	ctrlsFlag.textContent = '⚑';
	ctrlsFlag.onclick = function() {
		
	};
	ctrls.appendChild(ctrlsStar);
	ctrls.appendChild(ctrlsDelete);
	ctrls.appendChild(ctrlsFlag);
	cont.onscroll = function(e) {
		if (e &amp;&amp; !lock &amp;&amp; innerWidth >= 700 &amp;&amp; cont.children.length >= 92 &amp;&amp; skipped &amp;&amp; cont.scrollTop &lt; 72) {
			skipped = Math.max(0, skipped - 1);
			socket.send(JSON.stringify({event: 'req', skip: skipped}));
		}
		onBottom = cont.scrollTop + cont.offsetHeight >= cont.scrollHeight - 2;
	};
	addEventListener('resize', function() {
		if (onBottom) cont.scrollTop = cont.scrollHeight;
	});
	function send(value) {
		if (!(value = value || document.getElementById('ta').value)) return;
		socket.send(JSON.stringify({event: 'post', body: value}));
		location.hash = '';
		document.getElementById('ta').value = '';
		cont.scrollTop = cont.scrollHeight;
		cont.onscroll();
	};
	function statechange(nstate) {
		if (nstate == 1 &amp;&amp; document.getElementById('ta').value) nstate = 2;
		if (state != nstate) {
			state = nstate;
			socket.send(JSON.stringify({event: 'statechange', state: state}));
		}
	};
	function inactive() {
		statechange(0);
	};
	var timeout = setTimeout(inactive, 10000);
	function active() {
		clearTimeout(timeout);
		timeout = setTimeout(inactive, 10000);
		statechange(1);
	};
	addEventListener('keyup', active);
	addEventListener('keydown', active);
	addEventListener('click', active);
	addEventListener('mousemove', active);
	addEventListener('touchstart', active);
	addEventListener('scroll', active);
	addEventListener('resize', active);
	cont.addEventListener('scroll', active);
	socket.onmessage = function(e) {
		console.log(e.data);
		try {
			var data = JSON.parse(e.data);
		} catch(err) {
			console.log(err);
			return alert('JSON Error. Response was: ' + e.data);
		}
		if (data.event == 'init' || data.event == 'add') {
			var div = document.createElement('div');
			div.classList.add('comment');
			div.appendChild(document.createTextNode(data.body));
			var sig = document.createElement('span');
			sig.classList.add('c-sig');
			sig.appendChild(document.createTextNode('-' + data.user + ', '));
			var permalink = document.createElement('a');
			if (!data.time) data.time = new Date().getTime();
			permalink.appendChild(agot(data.time));
			permalink.href = '#' + (div.id = data.id);
			sig.appendChild(permalink);
			sig.appendChild(document.createTextNode(' '));
			div.appendChild(sig);
			var starcount = document.createElement('span');
			starcount.classList.add('starcount');
			starcount.appendChild(document.createTextNode((starcount.dataset.count = data.stars || 0) + '★'));
			sig.appendChild(starcount);
			var tCtrls = ctrls.cloneNode(true);
			tCtrls.children[0].onclick = ctrlsStar.onclick;
			tCtrls.children[1].onclick = ctrlsDelete.onclick;
			tCtrls.children[2].onclick = ctrlsFlag.onclick;
			if (user != data.user) tCtrls.removeChild(tCtrls.children[1]);
			if (user) div.appendChild(tCtrls);
			if (data.before) {
				cont.insertBefore(div, cont.firstChild);
				cont.scrollTop += div.offsetHeight;
			} else cont.appendChild(div);
			if (data.event == 'add') new Audio('/a/beep.mp3').play();
			if (onBottom &amp;&amp; !location.hash) cont.scrollTop = cont.scrollHeight;
			cont.onscroll();
		} else if (data.event == 'selfstar') {
			var e;
			if (e = document.getElementById(data.id)) e.getElementsByClassName('ctrls')[0].firstChild.classList.add('clkd');
		} else if (data.event == 'star') {
			if (e = document.getElementById(data.id)) {
				e = e.getElementsByClassName('starcount')[0]
				e.removeChild(e.firstChild);
				e.appendChild(document.createTextNode(++e.dataset.count + '★'));
				if (e = document.getElementById(data.id + 's')) {
					e = e.firstChild;
					var f;
					while (f = e.firstChild) e.removeChild(f);
					e.appendChild(document.createTextNode(++e.dataset.count + '★ '));
				} else {
					var li = document.createElement('li'),
						div = document.getElementById(data.id),
						id = div.id;
					div.id = '';
					var divClone = div.cloneNode(true);
					div.id = id;
					divClone.id = div.id + 's';
					divClone.removeChild(divClone.getElementsByClassName('ctrls')[0]);
					var starcountClone = divClone.getElementsByClassName('starcount')[0];
					starcountClone.appendChild(document.createTextNode(' '));
					divClone.insertBefore(starcountClone, divClone.firstChild);
					li.appendChild(divClone);
					document.getElementById('stars').appendChild(li);
				}
			} else request('/api/chat/' + data.id, function(res) {
					try {
						var data = JSON.parse(res);
					} catch(err) {
						console.log(err);
						return alert('JSON Error. Response was: ' + e.data);
					}
					var li = document.createElement('li'),
						div = document.createElement('div'),
						starcount = document.createElement('span'),
						sig = document.createElement('span');
					div.id = data.id + 's';
					div.classList.add('comment');
					starcount.classList.add('starcount');
					starcount.appendChild(document.createTextNode((starcount.dataset.count = data.stars) + '★ '));
					div.appendChild(starcount);
					div.appendChild(document.createTextNode(data.body));
					sig.classList.add('c-sig');
					sig.appendChild(document.createTextNode('-' + data.user + ', '));
					var permalink = document.createElement('a');
					if (!data.time) data.time = new Date().getTime();
					permalink.appendChild(agot(data.time));
					permalink.href = '#' + data.id;
					sig.appendChild(permalink);
					sig.appendChild(document.createTextNode(' '));
					div.appendChild(sig);
					li.appendChild(div);
					document.getElementById('stars').appendChild(li);
				});
		} else if (data.event == 'unstar') {
			if (e = document.getElementById(data.id)) {
				e = e.getElementsByClassName('starcount')[0];
				e.removeChild(e.firstChild);
				var count = --e.dataset.count;
				e.appendChild(document.createTextNode(count + '★'));
				if (e = document.getElementById(data.id + 's')) {
					if (count &lt; 1) return e.parentNode.parentNode.removeChild(e.parentNode);
					e = e.firstChild;
					var f;
					while (f = e.firstChild) e.removeChild(f);
					e.appendChild(document.createTextNode(count + '★ '));
				}
			}
		} else if (data.event == 'adduser') {
			var li = document.createElement('li');
			li.id = 'user-' + (li.textContent = data.name);
			document.getElementById('users').appendChild(li);
		} else if (data.event == 'deluser') {
			var li = document.getElementById('user-' + data.name);
			li.parentNode.removeChild(li);
		} else if (data.event == 'statechange') {
			if (data.state == 0) document.getElementById('user-' + data.user).classList.add('inactive');
			else document.getElementById('user-' + data.user).classList.remove('inactive');
			if (data.state == 2) document.getElementById('user-' + data.user).classList.add('writing');
			else document.getElementById('user-' + data.user).classList.remove('writing');
		} else if (data.event == 'info-skipped') {
			skipped = data.body;
			if (data.ts) {
				document.getElementById('ta').hidden = document.getElementById('btn').hidden = true;
				document.getElementById('ts').hidden = false;
			}
		} else if (data.event == 'info-complete') {
			lock = false;
			if (!isNaN(hash)) {
				location.hash = '';
				location.hash = '#' + hash;
			};
		} else if (data.event == 'info-update') {
			document.title = (document.getElementById('name').textContent = document.getElementById('nameedit').value = data.name) + ' | Chat | DevDoodle';
			document.getElementById('desc').textContent = document.getElementById('descedit').value = data.desc;
			var div = document.createElement('div');
			div.classList.add('comment');
			div.appendChild(document.createTextNode('Room description updated to "' + data.name + '": ' + data.desc));
			var sig = document.createElement('span');
			sig.classList.add('c-sig');
			sig.appendChild(document.createTextNode('-Bot, '));
			var permalink = document.createElement('a');
			if (!data.time) data.time = new Date().getTime();
			permalink.appendChild(agot(data.time));
			permalink.href = '#' + (div.id = data.id);
			sig.appendChild(permalink);
			sig.appendChild(document.createTextNode(' '));
			var starcount = document.createElement('span');
			starcount.classList.add('starcount');
			starcount.appendChild(document.createTextNode((starcount.dataset.count = 0) + '★'));
			sig.appendChild(starcount);
			div.appendChild(sig);
			if (data.before) cont.insertBefore(div, cont.firstChild);
			else cont.appendChild(div);
			if (data.event == 'add') new Audio('/a/beep.mp3').play();
			if (onBottom &amp;&amp; !location.hash) cont.scrollTop = cont.scrollHeight;
			cont.onscroll();
		} else if (data.event == 'err') {
			alert('Error: ' + data.body);
			if (data.revertInfo) {
				document.getElementById('nameedit').value = document.getElementById('name').textContent;
				document.getElementById('descedit').value = document.getElementById('desc').textContent;
			}
		}
	};
	socket.onclose = function() {
		if (confirm('Connection error. Reload?')) location.reload();
	};
	document.getElementById('ta').onkeypress = function(e) {
		if (e.keyCode == 13 &amp;&amp; !e.shiftKey &amp;&amp; !e.metaKey) {
			send();
			e.preventDefault();
		}
	};
	document.getElementById('edit').onclick = function() {
		document.getElementById('roominfo').hidden = true;
		document.getElementById('editform').hidden = false;
	};
	document.getElementById('editform').onsubmit = function() {
		document.getElementById('roominfo').hidden = false;
		document.getElementById('editform').hidden = true;
		socket.send(JSON.stringify({event: 'info-update', name: document.getElementById('nameedit').value, desc: document.getElementById('descedit').value}));
		return false;
	};
</script>
<style>
	#chat { height: 100% }
	.comment:hover { outline: 1px dotted #000 }
	.ctrls { border: 1px solid #aaa }
	.starcount {
		font-weight: bold;
		color: #d60;
		line-height: 1.2;
	}
	.starcount[data-count="0"] { display: none }
	.inactive {
		color: red;
		font-style: italic;
	}
	.writing {
		color: green;
		font-weight: bold;
	}
	#stars {
		list-style-type: none;
		padding: 0;
	}
	#stars li { margin: 4px 0 }
	#editform { margin: 0 }
	#users:empty::after { content: 'No users in room' }
	#stars:empty::after { content: 'No starred messages' }
	.comment:not(:hover) .ctrls:not(:hover) { display: none }
	@media (max-width: 699px) {
		#chat { width: 100% }
		#aside { display: none }
	}
	@media (min-width: 700px) {
		#chat { width: 80% }
		#aside { width: 19.5% }
	}
</style>