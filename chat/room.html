<div class="row" style="height: calc(100% - 120px)">
	<div id="chat" class="half scrly hglt pad pre" style="height: 100%; width: 80%;"></div>
	<div class="half umar" style="width: 19.5%">
		<div id="roominfo">
			<h1><span id="name">$name</span> <small><a id="edit">Edit</a></small></h1>
			<p id="desc">$desc</p>
		</div>
		<form id="editform" hidden="">
			<input id="nameedit" type="text" value="$name" class="large" />
			<textarea id="descedit" type="text" class="fullwidth">$desc</textarea>
			<button>Submit</button>
		</form>
		<hr />
		<h2>Users:</h2>
		<div id="users"></div>
	</div>
</div>
<textarea autofocus="" id="ta" class="umar" style="width: 100%; height: 96px;"></textarea><button id="btn" class="blk" onclick="send()">Post</button>
<p id="ts" hidden="">You are viewing old messages. <a href="/chat/$id">Join room</a>.</p>
<script>
	var noPageOverflow = 420;
	var hash = parseInt(location.hash.substr(1));
	var socket = new WebSocket('ws://localhost:8125/chat/$id' + (!isNaN(hash) ? '/' + hash : ''));
	var onBottom = true;
	var state = 1;
	var skipped;
	var cont = document.getElementById('chat');
	var lock = true;
	cont.onscroll = function(e) {
		if (!lock &amp;&amp; cont.children.length >= 92 &amp;&amp; skipped &amp;&amp; cont.scrollTop &lt; 144) {
			e.preventDefault();
			skipped = Math.max(0, skipped - 1);
			socket.send(JSON.stringify({event: 'req', skip: skipped}));
		}
		onBottom = cont.scrollTop + cont.offsetHeight >= cont.scrollHeight - 2;
	};
	function send(value) {
		if (!(value = value || document.getElementById('ta').value)) return;
		socket.send(JSON.stringify({event: 'post', body: value}));
		location.hash = '';
		document.getElementById('ta').value = '';
		cont.scrollTop = cont.scrollHeight;
		cont.onscroll();
	};
	function update(nstate) {
		if (nstate == 1 &amp;&amp; document.getElementById('ta').value) nstate = 2;
		if (state != nstate) {
			state = nstate;
			socket.send(JSON.stringify({event: 'update', state: state}));
		}
	};
	function inactive() {
		update(0);
	};
	var timeout = setTimeout(inactive, 10000);
	function active() {
		clearTimeout(timeout);
		timeout = setTimeout(inactive, 10000);
		update(1);
	};
	addEventListener('keyup', active);
	addEventListener('keydown', active);
	addEventListener('click', active);
	addEventListener('mousemove', active);
	addEventListener('touchstart', active);
	addEventListener('scroll', active);
	addEventListener('resize', active);
	cont.addEventListener('scroll', active);
	socket.onmessage = function(e) {
		console.log(e.data);
		try {
			var data = JSON.parse(e.data);
		} catch(err) {
			console.log(err);
			return alert('JSON Error. Response was: '+e.data);
		}
		if (data.event == 'init' || data.event == 'add') {
			var div = document.createElement('div');
			div.classList.add('hglt');
			div.classList.add('umar');
			div.classList.add('spad');
			div.classList.add('scrl');
			div.classList.add('clearfix');
			div.textContent = data.body;
			var sig = document.createElement('span');
			sig.classList.add('c-sig');
			sig.textContent = '-' + data.user + ', ';
			var permalink = document.createElement('a');
			if (!data.time) data.time = new Date().getTime();
			permalink.appendChild(agot(data.time));
			permalink.href = '#' + (div.id = data.num);
			sig.appendChild(permalink);
			div.appendChild(sig);
			if (data.before) cont.insertBefore(div, cont.firstChild);
			else cont.appendChild(div);
			if (data.event == 'add') new Audio('/a/beep.mp3').play();
			if (onBottom &amp;&amp; !location.hash) cont.scrollTop = cont.scrollHeight;
			else cont.scrollTop += div.offsetHeight;
			cont.onscroll();
		} else if (data.event == 'adduser') {
			var div = document.createElement('div');
			div.id = 'user-' + (div.textContent = data.name);
			document.getElementById('users').appendChild(div);
		} else if (data.event == 'deluser') {
			var div = document.getElementById('user-' + data.name);
			div.parentNode.removeChild(div);
		} else if (data.event == 'statechange') {
			if (data.state == 0)
				document.getElementById('user-' + data.user).classList.add('inactive');
			else
				document.getElementById('user-' + data.user).classList.remove('inactive');
			if (data.state == 2)
				document.getElementById('user-' + data.user).classList.add('writing');
			else
				document.getElementById('user-' + data.user).classList.remove('writing');
		} else if (data.event == 'info-skipped') {
			skipped = data.body;
			if (data.ts) {
				document.getElementById('ta').hidden = document.getElementById('btn').hidden = true;
				document.getElementById('ts').hidden = false;
			}
		} else if (data.event == 'info-complete') {
			complete();
		} else if (data.event == 'info-update') {
			document.title = (document.getElementById('name').textContent = document.getElementById('nameedit').value = data.name) + ' | Chat | DevDoodle';
			document.getElementById('desc').textContent = document.getElementById('descedit').value = data.desc;
			var div = document.createElement('div');
			div.classList.add('hglt');
			div.classList.add('umar');
			div.classList.add('spad');
			div.classList.add('scrl');
			div.classList.add('clearfix');
			div.textContent = 'Room description updated to "'+data.name+'": '+data.desc;
			var sig = document.createElement('span');
			sig.classList.add('c-sig');
			sig.textContent = '-Bot, ';
			var permalink = document.createElement('a');
			permalink.appendChild(agot(new Date().getTime()));
			permalink.href = '#' + data.num;
			sig.appendChild(permalink);
			div.appendChild(sig);
			cont.appendChild(div)
			if (onBottom &amp;&amp; !location.hash) cont.scrollTop = cont.scrollHeight;
			else cont.scrollTop += div.offsetHeight;
			cont.onscroll();
		} else if (data.event == 'err') {
			alert('Error: ' + data.body);
		}
	};
	socket.onclose = function() {
		if (confirm('Connection error. Reload?')) {
			location.reload();
		}
	};
	document.getElementById('ta').onkeypress = function(e) {
		if (e.keyCode == 13 &amp;&amp; !e.shiftKey &amp;&amp; !e.metaKey) {
			send();
			e.preventDefault();
		}
	};
	function complete() {
		lock = false;
		if (!isNaN(hash)) {
			location.hash = '';
			location.hash = '#' + hash;
		}
	};
	document.getElementById('edit').onclick = function() {
		document.getElementById('roominfo').hidden = true;
		document.getElementById('editform').hidden = false;
	};
	document.getElementById('editform').onsubmit = function() {
		document.getElementById('roominfo').hidden = false;
		document.getElementById('editform').hidden = true;
		socket.send(JSON.stringify({event: 'info-update', name: document.getElementById('nameedit').value, desc: document.getElementById('descedit').value}));
		return false;
	};
</script>
<style>
	.inactive {
		color: red;
		font-style: italic;
	}
	.writing {
		color: green;
		font-weight: bold;
	}
	#editform { margin: 0 }
</style>