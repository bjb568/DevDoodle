<div id="chat" class="scrly hglt pad pre" style="max-height: 80vh"></div>
<textarea autofocus="" id="ta" class="umar" style="width: 100%; height: 5vh; min-height: 18px;"></textarea><button class="blk" onclick="send()">Post</button>
<script>
	var socket = new WebSocket('ws://localhost:8125/chat');
	var onBottom = true;
	onscroll = function() {
		onBottom = document.getElementById('chat').scrollTop + document.getElementById('chat').offsetHeight >= document.getElementById('chat').scrollHeight - 2;
	};
	function send() {
		socket.send(JSON.stringify({body: document.getElementById('ta').value, idcookie: decodeURIComponent(document.cookie.replace(/(?:(?:^|.*;\s*)id\s*\=\s*([^;]*).*$)|^.*$/, '$1'))}));
		document.getElementById('ta').value = '';
		document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
		onscroll();
	};
	socket.onmessage = function(e) {
		var data = JSON.parse(e.data);
		if (data.event == 'init' || data.event == 'add') {
			var div = document.createElement('div');
			div.classList.add('hglt');
			div.classList.add('umar');
			div.classList.add('spad');
			div.classList.add('clearfix');
			div.textContent = data.body;
			var sig = document.createElement('span');
			sig.classList.add('c-sig');
			sig.textContent = '-' + data.user + ', ';
			if (!data.time) data.time = new Date().getTime();
			sig.appendChild(agot(data.time));
			div.appendChild(sig);
			document.getElementById('chat').appendChild(div);
			if (data.event == 'add') new Audio('/a/beep.mp3').play();
			if (onBottom) document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
		} else if (data.event == 'err') {
			alert('Error: ' + data.body);
		}
	};
	document.getElementById('ta').onkeypress = function(e) {
		if (e.keyCode == 13 &amp;&amp; !e.shiftKey &amp;&amp; !e.metaKey) {
			send();
			e.preventDefault();
		}
	};
</script>