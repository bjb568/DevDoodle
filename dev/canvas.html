<h1><span id="title">$title</span> <input type="text" id="edit-title" hidden="" value="$title" />  <small><a id="save">Save</a></small></h1>
<div id="row" class="row">
	<textarea id="code" placeholder="//code" spellcheck="false" autocapitalize="off" autocorrect="off" wrap="off">$code</textarea>
	<iframe id="output" sandbox="allow-scripts"></iframe>
</div>
<style>
	*::-webkit-input-placeholder { color: #888 }
	*::-moz-placeholder { color: #999 }
	body, #content, #footer { background: #000 }
	#content { padding-top: 0 }
	a:hover {
		color: #4ff;
	}
	a:active {
		color: #06f;
	}
	*:not(input):not(button) {
		color: #fff;
	}
	#code, #output {
		width: 95%;
		height: 500px;
		outline: none;
	}
	#code {
		color: #fff;
		background: #000;
		font-family: monospace;
		font-size: 1rem;
		border: 1px solid #fff;
		resize: none;
		margin-bottom: 8px;
	}
	@media (min-width: 650px) {
		h1 {
			height: 1.65rem;
			margin-bottom: .35em;
		}
		#row { height: calc(100% - 2rem) }
		#code, #output { height: 100% }
		#code { width: 60% }
		#output {
			width: 39%;
			float: right;
		}
	}
	@media (min-width: 650px) and (max-width: 800px) {
		#code { width: 55% }
		#output { width: 44% }
	}
	@media (min-width: 1600px) {
		#code { width: 65% }
		#output { width: 34% }
	}
	#save.progress {
		cursor: progress;
		color: #4ff;
	}
</style>
<script>
	var footerOff = true, noPageOverflow = 400;
	document.getElementById('code').onkeypress = function(e) {
		if (e.keyCode === 13) {
			var oldSelectionStart = this.selectionStart;
			var tabs = this.value.substr(0,oldSelectionStart).split('\n')[this.value.substr(0,oldSelectionStart).split('\n').length-1].split('\t').length-(('{([:'.indexOf(this.value[oldSelectionStart-1])+1)?0:1);
			this.value = this.value.substr(0,this.selectionStart)+'\n'+'\t'.repeat(tabs)+this.value.substr(this.selectionStart);
			this.selectionStart = ++oldSelectionStart + tabs;
			this.selectionEnd = this.selectionStart;
			e.preventDefault();
		}
		setTimeout(run, 0);
	};
	function createCode() {
		return '&lt;!DOCTYPE html>&lt;html>&lt;head>&lt;title>Output frame&lt;/title>&lt;/head>&lt;style>*{margin:0;max-width:100%;box-sizing:border-box}body{background:#000;color:#fff}#canvas{border:1px solid #fff;-webkit-user-select:none;-moz-user-select:none;cursor:default}#console{height:100px;background:#111;overflow:auto;margin-top:8px}#console:empty{display:none}button{display:block}&lt;/style>&lt;body>&lt;canvas id="canvas">&lt;/canvas>&lt;div id="console">&lt;/div>&lt;button onclick="location.reload()">Restart&lt;/button>&lt;script src="/dev/canvas.js">&lt;/script>&lt;script>\'use strict\';try{this.eval(' + JSON.stringify(document.getElementById('code').value) + ')}catch(e){error(e)}&lt;/script>&lt;/body>&lt;/html>';
	};
	function run() {
		document.getElementById('output').srcdoc = createCode();
	};
	var oldValue = document.getElementById('code').innerHTML;
	function handleCode() {
		if (this.value !== oldValue) {
			oldValue = this.value;
			onbeforeunload = function() {
				return 'You have unsaved code.';
			};
			if (!document.getElementById('save').classList.contains('progress')) document.getElementById('save').textContent = 'Save';
			run();
		}
	};
	var code = document.getElementById('code');
	code.addEventListener('keyup', handleCode);
	code.addEventListener('keydown', handleCode);
	code.addEventListener('keypress', function() {
		setTimeout(function(t) {
			handleCode.call(t);
		}, 0, this);
	});
	run();
	document.getElementById('save').onclick = function() {
		var e = this;
		if (e.classList.contains('progress')) return;
		e.classList.add('progress');
		setTimeout(function() {
			if (e.textContent == 'Save') e.textContent = 'Saving…';
		}, 200);
		request('/api/program/save?type=1', function(res) {
			if (res.indexOf('Error') === 0) {
				e.textContent = 'Retry?';
				alert(res);
			} else if (res.indexOf('Location') === 0) {
				onbeforeunload = null;
				location.href = res.split(' ')[1];
			} else if (res == 'Success') {
				onbeforeunload = null;
				e.textContent = 'Saved';
			} else alert('Unknown error. Response was: ' + res);
			e.classList.remove('progress');
		}, 'code=' + encodeURIComponent(document.getElementById('code').value));
	};
	(document.getElementById('fork') || {}).onclick = function() {
		var e = this;
		if (e.classList.contains('progress')) return;
		e.classList.add('progress');
		e.textContent = 'Saving…';
		var e = e.previousSibling.previousSibling;
		e.hidden = e.previousSibling.previousSibling.hidden = true;
		request('/api/program/save?type=1&amp;fork=1', function(res) {
			if (res.indexOf('Error') === 0) {
				e.hidden = false;
				e = e.nextSibling.nextSibling;
				e.hidden = false;
				e.nextSibling.nextSibling.textContent = 'Fork';
				alert(res);
			} else if (res.indexOf('Location') === 0) {
				onbeforeunload = null;
				location.href = res.split(' ')[1];
			} else alert('Unknown error. Response was: ' + res);
			e.classList.remove('progress');
		}, 'code=' + encodeURIComponent(document.getElementById('code').value));
	};
	document.getElementById('title').onclick = function() {
		this.hidden = true;
		var edit = document.getElementById('edit-title');
		edit.hidden = false;
		edit.focus();
	};
	document.getElementById('edit-title').onblur = function() {
		request('/api/program/edit-title', function(res) {
			var edit = document.getElementById('edit-title');
			if (res.indexOf('Error') === 0) {
				if (confirm(res + '\n\nRetry?')) edit.onblur();
				else {
					edit.hidden = true;
					document.getElementById('title').hidden = false;
				}
			} else if (res == 'Success') {
				edit.hidden = true;
				var title = document.getElementById('title');
				title.textContent = edit.value.substr(0, 92);
				title.hidden = false;
			} else alert('Unknown error. Response was: ' + res);
		}, 'title=' + encodeURIComponent(this.value));
	};
	document.getElementById('edit-title').onkeypress = function(e) {
		if (e.keyCode == 13) this.onblur.call(this);
	};
</script>