<h1>$title <small><a id="restart">Restart</a> <line /> <a id="save">Save</a></small></h1>
<div id="row" class="row">
	<textarea id="code" placeholder="//code" spellcheck="false" autocapitalize="off" autocorrect="off">$code</textarea>
	<iframe id="output" style="background-color: #fff" sandbox="allow-scripts allow-same-origin"></iframe>
</div>
<style>
	*::-webkit-input-placeholder { color: #888 }
	*::-moz-placeholder { color: #999 }
	body, #content, #footer { background: #000 }
	#content { padding-top: 0 }
	a:hover {
		color: #4ff;
	}
	a:active {
		color: #06f;
	}
	*:not(input):not(button) {
		color: #fff;
	}
	#code, #output {
		width: 95%;
		height: 500px;
		outline: none;
	}
	#code {
		color: #fff;
		background: #000;
		font-family: monospace;
		font-size: 1rem;
		border: 1px solid #fff;
		resize: none;
		white-space: nowrap;
		margin-bottom: 8px;
	}
	@media screen and (min-width: 650px) {
		h1 {
			height: 1.65rem;
			margin-bottom: .35em;
		}
		#row { height: calc(100% - 2rem) }
		#code, #output { height: 100% }
		#code { width: 60% }
		#output {
			width: 39%;
			float: right;
		}
	}
	@media screen and (min-width: 650px) and (max-width: 800px) {
		#code { width: 55% }
		#output { width: 44% }
	}
	@media screen and (min-width: 1600px) {
		#code { width: 65% }
		#output { width: 34% }
	}
	#save.p {
		cursor: progress;
		pointer-events: none;
		color: #000;
	}
</style>
<script>
	var footerOff = true, noPageOverflow = 400;
	document.getElementById('code').onkeypress = function(e) {
		if (e.keyCode === 13) {
			var oldSelectionStart = this.selectionStart;
			var tabs = this.value.substr(0,oldSelectionStart).split('\n')[this.value.substr(0,oldSelectionStart).split('\n').length-1].split('\t').length-((false/*Parse!*/)?0:1);
			this.value = this.value.substr(0,this.selectionStart)+'\n'+'\t'.repeat(tabs)+this.value.substr(this.selectionStart);
			this.selectionStart = ++oldSelectionStart + tabs;
			this.selectionEnd = this.selectionStart;
			e.preventDefault();
		}
		setTimeout(run, 0);
	};
	var textarea = document.createElement('textarea');
	document.body.appendChild(textarea);
	textarea.style.position = 'fixed';
	textarea.style.opacity = .001;
	function handleTA() {
		if (document.activeElement == document.body) {
			textarea.focus();
		} else if (document.activeElement == textarea) {
			if (textarea.value) {
				outputWindow.key = textarea.value;
				textarea.value = '';
			}
		}
	};
	handleTA();
	addEventListener('keydown', function(e) {
		if (document.activeElement == textarea &amp;&amp; outputWindow) {
			outputWindow.keyCodes[e.keyCode] = true;
		}
		handleTA();
	});
	addEventListener('keyup', function(e) {
		if (document.activeElement == textarea &amp;&amp; outputWindow) {
			delete outputWindow.keyCodes[e.keyCode];
		}
		handleTA();
	});
	addEventListener('keypress', handleTA);
	function createCode() {
		return '&lt;!DOCTYPE html>&lt;html>&lt;head>&lt;title>Output frame&lt;/title>&lt;/head>&lt;style>*{margin:0;max-width:100%;box-sizing:border-box}body{background:#000;color:#fff}#canvas{border:1px solid #fff;-webkit-user-select:none;-moz-user-select:none;cursor:default}#console{height:100px;background:#111;overflow:auto;margin-top:8px}#console:empty{display:none}&lt;/style>&lt;body>&lt;canvas id="canvas">&lt;/canvas>&lt;div id="console">&lt;/div>&lt;script>var code='+JSON.stringify(document.getElementById('code').value)+';&lt;/script>&lt;script src="/dev/canvas.js">&lt;/script>&lt;/body>&lt;/html>';
	};
	var outputWindow;
	function run() {
		document.getElementById('output').srcdoc = createCode();
		outputWindow = document.getElementById('output').contentWindow;
	};
	if (navigator.userAgent.indexOf('Mobile') === -1) {
		addEventListener('mousemove',function(e) {
			try {
				var cRect = outputWindow.canvas.getBoundingClientRect(), iRect = document.getElementById('output').getBoundingClientRect();
				outputWindow.mouseX = (e.clientX - Math.round(cRect.left + iRect.left)) / cRect.width * outputWindow.width;
				outputWindow.mouseY = (e.clientY - Math.round(cRect.top + iRect.top)) / cRect.height * outputWindow.height;
				outputWindow.mouseX = outputWindow.mouseX.bound(0,outputWindow.width);
				outputWindow.mouseY = outputWindow.mouseY.bound(0,outputWindow.height);
			} catch(e) {}
		},false);
		addEventListener('mouseup', function() {
			outputWindow.mousePressed = false;
		},false);
	};
	var oldValue = document.getElementById('code').innerHTML;
	function handleCode() {
		if (this.value !== oldValue) {
			oldValue = this.value;
			onbeforeunload = function() {
				return 'You have unsaved code.';
			};
			run();
		}
	};
	document.getElementById('code').addEventListener('keyup', handleCode);
	document.getElementById('code').addEventListener('keydown', handleCode);
	document.getElementById('code').addEventListener('keypress', function() {
		setTimeout(function(t) {
			handleCode.call(t);
		}, 0, this);
	});
	run();
	document.getElementById('restart').onclick = run;
	document.getElementById('save').onclick = function() {
		request('/api/program/save?type=1', function(res) {
			if (res.indexOf('Error') === 0) alert(res);
			else if (res.indexOf('Location') === 0) {
				onbeforeunload = null;
				location.href = res.split(' ')[1];
			}
		}, 'code=' + encodeURIComponent(document.getElementById('code').value));
	};
</script>