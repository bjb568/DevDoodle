<form action="?preview=1&amp;submit=0" method="POST" class="row">
	<div id="text">
		<div id="text-inner">
			<h1><input type="text" value="$title" name="title" placeholder="Lesson Title" autofocus="" required="" /></h1>
			<h2><input type="text" value="$stitle" name="stitle" placeholder="Section Title" required="" /></h2>
			<textarea name="sbody" placeholder="Section Content" required="">$sbody</textarea>
			<h2>JS validator code <small class="nofloat">(<a href="/learn/api/validation" target="_blank">API</a>)</small></h2>
			<div id="ta-cont">
				<textarea id="validate" name="validate" autocapitalize="none" autocomplete="off" spellcheck="false">function validate(data) {
	if (data.indexOf('test') == -1) {
		return {
			success: false,
			msg: 'Did you remember to foo the bar?'
		};
	}
	return {
		success: true,
		msg: 'You did it!'
	};
}</textarea>
				<code id="validate-display"></code>
			</div>
			<div id="checker">
				<button type="button" id="check" class="blk">Test User Submit</button>
				<div id="passed" class="passed clearfix">
					<h2><span id="passtext"> </span> <small class="rit" style="font-size: 14px; top: 6px;"><a href="../2/">Move on â†’</a></small></h2>
				</div>
				<div id="failed" class="failed clearfix">
					<h2>Try Again</h2>
					<p id="fail"> </p>
				</div>
			</div>
		</div>
		<div id="cntrls"><button type="submit">Preview Lesson</button></div>
	</div>
	<textarea id="html" name="html">$html</textarea>
	<iframe id="output"></iframe>
</form>
<textarea hidden="" id="canvas-js">$canvasjs</textarea>
<script src="/dev/runcanvas.js"></script>
	#text-inner input, textarea { width: 100% }
	h1, h2 { border: none }
	#text-inner h1 { margin: 2px 0 0 }
	#ta-cont {
		background: #000;
		margin-bottom: 8px;
		position: relative;
		overflow: auto;
		border: 1px solid #fff;
	}
	#validate, #validate-display {
		display: block;
		min-height: 100%;
		padding: 0;
		margin: 2px;
		color: #fff;
		background: transparent;
		font-family: monospace;
		white-space: pre-wrap;
		word-wrap: break-word;
		overflow-wrap: break-word;
		font-size: 1rem;
		line-height: 1.2;
		resize: none;
		outline: none;
		border: none;
		padding-left: 4px;
	}
	#validate {
		position: absolute;
		top: 0; right: 0;
		z-index: 1;
		color: transparent;
	}
	#validate-display {
		width: calc(100% - 4px);
		border-left: 1px solid #444;
		padding-right: 1px;
	}
	#caret {
		display: inline-block;
		position: absolute;
		background: #fff;
		width: 1px;
	}
	#caret[hidden] { display: none }
	textarea, #ta-cont { height: 400px }
	#cntrls {
		padding: 4px;
		background: #0ff;
	}
	#cntrls button {
		height: 20px;
		width: 120px;
	}
</style>
<textarea hidden="" id="canvas-js">$canvasjs</textarea>
<script src="/dev/runcanvas.js"></script>
	var footerOff = true,
		noPageOverflow = 520,
		htmlTA = document.getElementById('html'),
		code = document.getElementById('validate'),
		codeDisplay = document.getElementById('validate-display'),
		taCont = document.getElementById('ta-cont');
	document.getElementById('check').onclick = function(e) {
		e.preventDefault();
		var checkerWorker = new Worker(URL.createObjectURL(new Blob([code.value + '\n;onmessage = function(e) { postMessage(validate(e.data)); }'])));
		checkerWorker.postMessage(htmlTA.value);
		checkerWorker.onerror = checkerWorker.onmessage = function(e) {
			if (e instanceof ErrorEvent) alert(e.message);
			console.log(e);
			var success = !e || !e.data || e.data.success;
			var msg = !e || !e.data || typeof(e.data.msg) != 'string' ? 'You did it!' : e.data.msg;
			document.getElementById(success ? 'passed' : 'failed').classList.add('show');
			document.getElementById(success ? 'failed' : 'passed').classList.remove('show');
			document.getElementById(success ? 'passtext' : 'fail').firstChild.nodeValue = msg;
			checkerWorker.terminate();
		};
	};
	var runTimeout;
	function run() {
		document.getElementById('output').src = 'data:application/xhtml+xml; charset=utf-8,' + document.getElementById('html').value;
	}
	run();
	function beforeRun() {
		clearTimeout(runTimeout);
		runTimeout = setTimeout(run, 100);
	}
	htmlTA.addEventListener('keyup', beforeRun);
	htmlTA.addEventListener('keydown', beforeRun);
	htmlTA.addEventListener('keypress', beforeRun);
	var blinkTimeout;
	function blink() {
		document.getElementById('caret').hidden ^= 1;
		blinkTimeout = setTimeout(blink, 500);
	}
	function insertNodeAtPosition(node, refNode, pos) {
		if (typeof(refNode.nodeValue) == 'string') refNode.parentNode.insertBefore(node, refNode.splitText(pos));
		else {
			for (var i = 0; i &lt; refNode.childNodes.length; i++) {
				var chNode = refNode.childNodes[i];
				if (chNode.textContent.length &lt;= pos &amp;&amp; i != refNode.childNodes.length - 1) pos -= chNode.textContent.length;
				else return insertNodeAtPosition(node, chNode, pos);
			}
		}
	}
	code.lastSelectionStart = 0;
	code.lastSelectionEnd = 0;
	code.lastCursorPos = 0;
	code.whichSelection = true;
	highlight(codeDisplay, code.lastValue = code.value);
	taCont.className = codeDisplay.className;
	var caret = document.createElement('span');
	caret.id = 'caret';
	caret.appendChild(document.createTextNode('\xA0'));
	codeDisplay.insertAfter(caret, codeDisplay.firstChild);
	caret.hidden = true;
	function handleTAInput() {
		var codeScrollDiff = code.scrollHeight - code.offsetHeight;
		if (code.value != code.lastValue) {
			highlight(codeDisplay, code.lastValue = code.value);
			taCont.className = codeDisplay.className;
		}
		code.style.height = codeDisplay.offsetHeight + 'px';
		taCont.scrollTop += codeScrollDiff;
		if (code.selectionStart != code.lastSelectionStart) {
			code.lastSelectionStart = code.selectionStart;
			code.whichSelection = false;
		}
		if (code.selectionEnd != code.lastSelectionEnd) {
			code.lastSelectionEnd = code.selectionEnd;
			code.whichSelection = true;
		}
		var cursorPos = code.whichSelection ? code.selectionEnd : code.selectionStart;
		var oldCaret = document.getElementById('caret');
		if (cursorPos != code.lastCursorPos || !oldCaret) {
			code.lastCursorPos = cursorPos;
			if (oldCaret) oldCaret.parentNode.removeChild(oldCaret);
			var caret = document.createElement('span');
			caret.id = 'caret';
			caret.appendChild(document.createTextNode('\xA0'));
			insertNodeAtPosition(caret, codeDisplay, cursorPos);
			clearTimeout(blinkTimeout);
			blinkTimeout = setTimeout(blink, 500);
		}
	}
	code.addEventListener('keypress', function() {
		setTimeout(handleTAInput, 0);
	});
	code.addEventListener('keyup', function() {
		setTimeout(handleTAInput, 0);
	});
	code.addEventListener('keydown', function() {
		setTimeout(handleTAInput, 0);
	});
	code.addEventListener('mousedown', function() {
		setTimeout(handleTAInput, 0);
	});
	addEventListener('mousemove', function() {
		setTimeout(handleTAInput, 0);
	});
	code.addEventListener('input', handleTAInput);
	code.addEventListener('blur', function() {
		document.getElementById('caret').hidden = true;
		clearTimeout(blinkTimeout);
	});
	code.addEventListener('focus', function() {
		document.getElementById('caret').hidden = false;
		clearTimeout(blinkTimeout);
		blinkTimeout = setTimeout(blink, 500);
	});
	code.addEventListener('keypress', function(e) {
		var oldSelectionStart = this.selectionStart;
		var pairChars = {};
		pairChars[40] = '()';
		pairChars[91] = '[]';
		pairChars[123] = '{}';
		var endChars = {};
		endChars[41] = ')';
		endChars[93] = ']';
		endChars[125] = '}';
		if (e.keyCode == 13) {
			var cut = (this.value.substr(0, oldSelectionStart).match(/(\S([ \t]+)| +)$/) || ['', '', ''])[2].length;
			this.value = this.value.substr(0, oldSelectionStart - cut) + this.value.substr(oldSelectionStart);
			oldSelectionStart = this.selectionStart = this.selectionEnd = oldSelectionStart - cut;
			if (this.value[oldSelectionStart - 1] == ',') this.eIndent = true;
			var tabs = this.value.substr(0, oldSelectionStart)
				.split('\n')[this.value.substr(0, oldSelectionStart).split('\n').length - 1]
				.split('\t').length
				- (
					('{([:'.indexOf(this.value[oldSelectionStart - 1]) + 1)
					? 0
					: (
						this.value[oldSelectionStart - 1] == ';' &amp;&amp; this.eIndent
						? (this.eIndent = false || 2)
						: 1
					)
				);
			this.value = this.value.substr(0, this.selectionStart) + '\n' + '\t'.repeat(tabs) + (['{}', '()', '[]'].indexOf(this.value.substr(oldSelectionStart - 1, 2)) == -1 ? '' : '\n' + '\t'.repeat(tabs - 1)) + this.value.substr(this.selectionStart);
			this.selectionEnd = this.selectionStart = ++oldSelectionStart + tabs;
			e.preventDefault();
		} else if (e.charCode == 34) {
			if (this.value[this.selectionStart] != '"') this.value = this.value.substr(0, this.selectionStart) + '""' + this.value.substr(this.selectionStart);
			this.selectionEnd = this.selectionStart = ++oldSelectionStart;
			e.preventDefault();
		} else if (e.charCode == 39) {
			if (this.value[this.selectionStart] != "'") this.value = this.value.substr(0, this.selectionStart) + "''" + this.value.substr(this.selectionStart);
			this.selectionEnd = this.selectionStart = ++oldSelectionStart;
			e.preventDefault();
		} else if (pairChars[e.keyCode]) {
			this.value = this.value.substr(0, this.selectionStart) + pairChars[e.keyCode] + this.value.substr(this.selectionStart);
			this.selectionEnd = ++oldSelectionStart;
			e.preventDefault();
		} else if (endChars[e.keyCode] &amp;&amp; this.value[this.selectionStart] == endChars[e.keyCode]) {
			this.selectionStart = ++this.selectionEnd;
			e.preventDefault();
		} else if (e.keyCode == 61 &amp;&amp; this.value.substr(0, this.selectionStart).match(/(draw|refresh) $/)) {
			var tabs = this.value.substr(0, oldSelectionStart).split('\n')[this.value.substr(0, oldSelectionStart).split('\n').length - 1].split('\t').length;
			this.value = this.value.substr(0, this.selectionStart) + '= function() {\n' + '\t'.repeat(tabs) + '\n' + '\t'.repeat(tabs - 1) + '};' + this.value.substr(this.selectionStart);
			this.selectionEnd = this.selectionStart = oldSelectionStart + 15 + tabs;
			e.preventDefault();
		} else if (e.keyCode == 44) {
			this.value = this.value.substr(0, this.selectionStart) + ', ' + this.value.substr(this.selectionStart);
			this.selectionEnd = this.selectionStart = oldSelectionStart + 2;
			e.preventDefault();
		} else if (e.keyCode == 58) {
			this.value = this.value.substr(0, this.selectionStart) + ': ' + this.value.substr(this.selectionStart);
			this.selectionEnd = this.selectionStart = oldSelectionStart + 2;
			e.preventDefault();
		} else if (e.keyCode == 125 &amp;&amp; this.value[this.selectionStart - 1] == '\t') {
			this.value = this.value.substr(0, this.selectionStart - 1) + '}' + this.value.substr(this.selectionStart);
			this.selectionEnd = this.selectionStart = oldSelectionStart;
			e.preventDefault();
		}
	});
	code.addEventListener('keydown', function(e) {
		if (e.keyCode == 8 &amp;&amp; this.selectionStart == this.selectionEnd) {
			if (
				(this.value[this.selectionStart - 1] == '"' &amp;&amp; this.value[this.selectionStart] == '"') ||
				(this.value[this.selectionStart - 1] == "'" &amp;&amp; this.value[this.selectionStart] == "'") ||
				(this.value[this.selectionStart - 1] == '(' &amp;&amp; this.value[this.selectionStart] == ')') ||
				(this.value[this.selectionStart - 1] == '[' &amp;&amp; this.value[this.selectionStart] == ']') ||
				(this.value[this.selectionStart - 1] == '{' &amp;&amp; this.value[this.selectionStart] == '}')
			) {
				var oldSelectionStart = this.selectionStart;
				this.value = this.value.substr(0, this.selectionStart - 1) + this.value.substr(this.selectionStart + 1);
				this.selectionEnd = --oldSelectionStart;
				e.preventDefault();
			}
		}
	});
</script>