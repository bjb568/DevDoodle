<h1>New Question</h1>
<form id="form" method="post" action="/api/question/add">
	<fieldset id="step0">
		<h2><input type="text" name="title" placeholder="Title" id="title" autofocus="" class="fullwidth" maxlength="144" /></h2>
		<h2><input type="text" name="lang" placeholder="Language" id="lang" /></h2>
		<div id="langsug" hidden="" class="abs"></div>
		<button type="submit" id="submit1">Next</button>
		<div id="err1" class="err"></div>
	</fieldset>
	<aside id="titlehelp" class="rit">
		<h2>Writing a good title</h2>
		<p>Your question's title is the first thing seen by readers skimming thru questions both here and on search engines. A title effectively capture the essence of the question. Try to avoid titles like:</p>
		<ul>
			<li><strong>"Is it possible to…"</strong> (you want to know <em>how</em> to do something)</li>
			<li><strong>X in [some language]</strong> (what about <em>X</em>?)</li>
			<li><strong>"XYZ error"</strong> (when doing <em>what?</em>)</li>
			<li><strong>"Should I…"</strong> or <strong>"Is … a good idea?"</strong> (describe the <em>problem</em>, not the attempted (or not) solution)</li>
			<li><strong>"Is X or Y better?"</strong> (in <em>what way?</em>)</li>
			<li><strong>"Should I use X or Y?"</strong> (<em>"Is X or Y better at… ?"</em> is a better phrasing that doesn't depend on your specific circumstances)</li>
			<li><strong>"How can I replicate [some feature]?"</strong> (say what specifically you need help with accomplishing keeping in mind that not as many people as you'd think know about [some feature])</li>
			<li><strong>"Is this code good?"</strong> (be <em>specific</em> about what coding practice you want to learn more about)</li>
		</ul>
		<p>Remember to keep it as short and concise as possible while still accurately describing the problem.</p>
	</aside>
	<fieldset id="step1" class="hide">
		<h2>Has your question already been asked before? <small><button id="reload-dups">↻</button></small></h2>
		<div class="hglt pad bmar">
			<ul id="duplist"></ul>
		</div>
		<button type="submit" id="submit2" disabled="" hidden="">None of these are the same as my question</button>
	</fieldset>
	<fieldset id="step2" class="hide">
		<h2>Question Body</h2>
		<div class="ta-cont">
			<textarea name="description" id="description" placeholder="Description"></textarea>
			<pre></pre>
		</div>
		<h2><input type="text" name="question" id="question" placeholder="Core Question" class="fullwidth" maxlength="144" /></h2>
		<button type="submit" id="submit3" hidden="">Next</button>
		<div id="err3" class="err"></div>
	</fieldset>
	<aside id="explainhelp" class="hide rit">
		<h2>Explaining your problem</h2>
		<p>In the description box, you want to describe your problem in detail. <em>Include any information needed to setup the environment, replicate the bug, or observe the problematic behavior.</em> Be <strong>clear</strong> about what exactly you did, struggled with, and would like us to help with. The core question box is for your specific request <em>in one well-written sentence</em>, for example "How can I flow foo thru bar?".</p>
	</aside>
	<fieldset id="step3" class="hide">
		<h2>Code</h2>
		<div class="ta-cont" autocapitalize="none" autocomplete="off" spellcheck="false">
			<textarea name="code" id="code" placeholder="//code (optional)"></textarea>
			<pre></pre>
		</div>
		<button type="submit" id="submit4" hidden="">Almost done!</button>
	</fieldset>
	<aside id="codehelp" class="hide rit">
		<h2>Adding relevant code</h2>
		<p>What code showcases the problem you're asking about? You'll want to make it easy to run the code and locate the issue (whatever it might be), but too much code can be hard to debug and understand. A good way of finding out what's going on in your code is to comment out a few lines at a time until you either have very little code or the problem has gone away. If you can fix it by yourself this way, that's great! But even if you can't, you've narrowed down the code that may contain the culprit and now have a succinct snippet of code to share with us. <strong>After isolating the problem, you should have a small code snippit that reproduces the issue, generally under 48 lines.</strong> Make sure you take out sensitive information and clean up the code before posting it here.</p>
	</aside>
	<fieldset id="step4" class="hide">
		<h2>Categorization</h2>
		<h3>My question is about…</h3>
		<div id="types">
			<label for="type-err"><input type="radio" name="type" value="err" id="type-err" /> fixing non-working code</label>
			<label for="type-bug"><input type="radio" name="type" value="bug" id="type-bug" /> unexpected behavior in working code</label>
			<label for="type-imp"><input type="radio" name="type" value="imp" id="type-imp" /> improving working code</label>
			<label for="type-how"><input type="radio" name="type" value="how" id="type-how" /> how to achieve an end result</label>
			<label for="type-alg"><input type="radio" name="type" value="alg" id="type-alg" /> algorithms and data structures</label>
			<label for="type-pra"><input type="radio" name="type" value="pra" id="type-pra" /> techniques and best practices</label>
			<label for="type-the"><input type="radio" name="type" value="the" id="type-the" /> a theoretical scenario</label>
		</div>
		<h3>This question is specific to…</h3>
		<input type="hidden" name="tags" id="tags-input" />
		<div id="tags"></div>
		<h3>Options</h3>
		<div id="options">
			<div><label for="gr"><input type="checkbox" name="gr" id="gr" /> General Reference</label> <small>(a broad question with only a single community-owned answer)</small></div>
			<div><label for="self"><input type="checkbox" name="self" id="self" /> Self-answered</label> <small>(share your knowledge by answering your own question – you can still add an answer later if you don't check this)</small></div>
			<div><label for="bounty"><input type="checkbox" name="bounty" id="bounty" /> Bounty</label> <small>(make question featured, costs 50 reputation per day which can be awarded to an answerer)</small></div>
		</div>
		<button id="showpreview" class="umar" disabled="">Show Question Preview</button>
	</fieldset>
</form>
<article id="preview" class="popup" hidden=""></article>
<style>
	form {
		padding: 0 4px;
		width: 100%;
	}
	aside { clear: right }
	label { display: table }
	#options label { display: inline }
	@media (min-width: 701px) {
		fieldset {
			width: calc(90% - 306px);
			float: left;
			clear: left;
		}
	}
	@media (max-width: 909px) {
		#duplist, aside { font-size: 0.95em }
	}
	@media (max-width: 759px) {
		#duplist, aside { font-size: 0.9em }
	}
	.ta-cont {
		position: relative;
		width: 100%;
		min-height: 360px;
	}
	.ta-cont pre {
		padding: 3px;
		visibility: hidden;
	}
	.ta-cont pre, textarea {
		position: absolute;
		top: 0; left: 0;
		width: 100%;
		font-size: .9em;
		font-family: inherit;
		line-height: 1.2;
		white-space: pre-wrap;
	}
	textarea {
		height: 100%;
		resize: none;
	}
	#step4 h3 { margin-bottom: 4px }
	#types, #tags, #options { padding-left: 32px }
	#langsug {
		padding: 8px 3px 4px;
		background: #eee;
		margin-top: -5px;
		box-shadow: 1px 3px 3px #444;
	}
	#langsug span {
		cursor: pointer;
		background: #afa;
		padding: 2px 6px;
		box-shadow: 1px 1px 1px #444;
	}
	fieldset.hide, aside.hide:not(:hover) { opacity: 0.15 }
	fieldset.hide { pointer-events: none }
	fieldset, aside, #preview { transition: opacity 0.5s }
	#preview[hidden] { opacity: 0 }
	.err {
		position: absolute;
		padding: 8px;
		width: 300px;
		background: #f00;
		z-index: 1;
	}
	.err:empty { opacity: 0 }
	#duplist { padding-left: 1.5em }
	#duplist:empty { padding: 0 }
	#duplist:empty::after {
		content: 'Loading possible duplicates…';
		color: #666;
		font-size: 0.8em;
	}
	.hide #duplist::after { content: '(Enter a title and language)' }
	#tags:empty::after {
		content: '(Enter a language)';
		color: #666;
		font-size: 0.8em;
	}
	#preview {
		position: fixed;
		overflow: hidden;
		z-index: 1;
		background: #ddd;
	}
	#preview h1 small { cursor: pointer }
	.tint::after {
		content: '';
		display: block; position: fixed;
		top: 0; right: 0; bottom: 0; left: 0;
		background: rgba(0, 0, 0, 0.5);
	}
	.tint #nav, .tint #footer, .tint #content > :not(article) { -webkit-filter: blur(2px) }
	#submit {
		font-size: 1.1em;
		color: #fff;
		background: #04f;
		padding: 6px 24px;
		border-radius: 4px;
		transition: background 0.2s;
		margin-top: 12px;
		border: 1px solid #000;
		cursor: pointer;
	}
	#submit:hover {
		background: #6cf;
		color: #000;
		transition: background 0.1s;
	}
	#submit:active, #submit.working { background: #2af }
	#err1.tag-warning { background: #ff0}
</style>
<script>
	var form = document.getElementById('form'),
		title = document.getElementById('title'),
		lang = document.getElementById('lang'),
		langsug = document.getElementById('langsug'),
		description = document.getElementById('description'),
		question = document.getElementById('question'),
		code = document.getElementById('code'),
		tags = document.getElementById('tags'),
		err1 = document.getElementById('err1'),
		err3 = document.getElementById('err3');
	function smoothScroll(el, t, p, s) {
		var dist = el.getBoundingClientRect().top,
			now = new Date().getTime(),
			p = t - p,
			s = s || now,
			elapsed = now - s;
		if (dist > 6 &amp;&amp; document.body.scrollTop - document.body.scrollHeight + innerHeight) {
			scrollBy(0, Math.min(dist - 5, Math.max(1, p * dist * elapsed * elapsed / 50000000)));
			requestAnimationFrame(function(p) {
				smoothScroll(el, p, t, s);
			});
		}
	};
	addEventListener('input', function() {
		if (document.activeElement.parentNode.classList.contains('ta-cont')) {
			document.activeElement.nextElementSibling.textContent = document.activeElement.value + '\n';
			document.activeElement.parentNode.style.height = document.activeElement.nextElementSibling.offsetHeight + 'px';
		}
	});
	var step = 0,
		langs = $langs,
		waiting = false;
	lang.addEventListener('keyup', function() {
		if (!(langsug.hidden = !this.value)) {
			var firstChild;
			while (firstChild = langsug.firstChild) langsug.removeChild(firstChild);
			var i = this.value.length,
				used = [];
			while (used.length &lt; 2) {
				for (var j = 0; j &lt; langs.length; j++) {
					if (used.indexOf(langs[j]) == -1 &amp;&amp; langs[j].substr(0, i).toLowerCase() == this.value.substr(0, i).toLowerCase()) {
						used.push(langs[j]);
						var span = document.createElement('span');
						span.appendChild(document.createTextNode(langs[j]));
						span.onmousedown = function(e) {
							e.preventDefault();
							lang.value = this.textContent;
							this.parentNode.hidden = true;
							findTags();
						};
						langsug.appendChild(span);
						langsug.appendChild(document.createTextNode(' '));
					}
				}
				if (i == 0) return;
				i--;
			}
		}
	});
	lang.addEventListener('keydown', function(e) {
		if (this.value &amp;&amp; e.keyCode == 9) {
			this.value = langsug.firstChild.textContent;
			form.onsubmit();
		}
	});
	function findDups() {
		request('/api/question/search', function(res) {
			try {
				res = JSON.parse(res);
			} catch(e) {
				alert('JSON Error. Response was: ' + res);
				res = [];
			}
			var duplist = document.getElementById('duplist'), fc;
			while (fc = duplist.firstChild) duplist.removeChild(fc);
			for (var i = 0; i &lt; res.length; i++) {
				var li = document.createElement('li'),
					h3 = document.createElement('h3'),
					a = document.createElement('a');
				a.appendChild(document.createTextNode(res[i].title.replace(/(\S{30})\S*/g, '$1')));
				a.href = res[i]._id;
				a.target = '_blank';
				h3.appendChild(a);
				li.appendChild(h3);
				var blockquote = document.createElement('blockquote');
				blockquote.innerHTML = markdown(res[i].body.replace(/(\S{30})\S*/g, '$1'));
				li.appendChild(blockquote);
				duplist.appendChild(li);
			}
			if (!res.length) {
				duplist.appendChild(document.createTextNode('No related questions found.'));
				form.onsubmit();
			}
		}, 'lang=' + encodeURIComponent(lang.value) + '&amp;search=' + encodeURIComponent(title.value));
	}
	document.getElementById('reload-dups').onclick = function(e) {
		e.preventDefault();
		findDups();
	};
	lang.addEventListener('blur', function() {
		langsug.hidden = true;
	});
	lang.addEventListener('focus', function() {
		langsug.hidden = !this.value;
	});
	function findTags() {
		var fc;
		while (fc = tags.firstChild) tags.removeChild(fc);
		if (!lang.value) return;
		request('/api/qa/tags', function(res) {
			var child;
			while (child = tags.firstChild) tags.removeChild(child);
			if (res.indexOf('Error:') == 0) return alert(res);
			if (res == '[]' &amp;&amp; !err1.textContent){
				err1.classList.add('tag-warning');
				return err1.textContent = 'No tags found for language.';
			}
			try {
				res = JSON.parse(res);
			} catch(e) {
				return alert('JSON error. Response was: ' + res);
			}
			var labels = {};
			for (var i = 0; i &lt; res.length; i++) {
				var label = document.createElement('label'),
					checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.id = 'tag' + res[i]._id;
				label.appendChild(checkbox);
				label.appendChild(document.createTextNode(' ' + res[i].name));
				labels[res[i]._id] = label;
			}
			var divs = {};
			for (var i = 0; i &lt; res.length; i++) {
				if (!res[i].parentID) tags.appendChild(labels[res[i]._id]);
				else {
					if (!divs[res[i].parentID]) {
						divs[res[i].parentID] = document.createElement('div');
						divs[res[i].parentID].classList.add('indt');
						labels[res[i].parentID].addEventListener('click', function() {
							if (!this.children[0].checked) {
								var e = this.nextElementSibling.getElementsByTagName('input');
								for (var i = 0; i &lt; e.length; i++) e[i].checked = false;
							}
						});
					}
					divs[res[i].parentID].appendChild(labels[res[i]._id]);
					labels[res[i]._id].onclick = function() {
						if (this.children[0].checked) {
							var ref = this.parentNode.previousElementSibling;
							ref.children[0].checked = true;
							if (ref.onclick) ref.onclick();
						}
					};
				}
			}
			for (var i in divs) {
				var ref = document.getElementById('tag' + i).parentNode;
				ref.parentNode.insertAfter(divs[i], ref);
			}
			if (!err1.classList.contains('tag-warning')) return;
			err1.classList.remove('tag-warning');
			form.onsubmit();
		}, 'lang=' + encodeURIComponent(lang.value));
	};
	lang.onblur = findTags;
	form.onsubmit = function(e) {
		if (e) {
			e.preventDefault();
			if (waiting) return;
		}
		if (step == 0) {
			if (!tags.children.length) {
				lang.focus();
				err1.classList.add('tag-warning');
				err1.textContent = 'No tags found for language.';
				return;
			}
			err1.classList.remove('tag-warning');
			if (title.value.length &lt; 12) {
				title.focus();
				err1.textContent = 'Title must be at least 12 characters long.';
				return;
			}
			if (title.value.length > 144) {
				title.focus();
				err1.textContent = 'Title must be at most 144 characters long.';
				return;
			}
			if (!lang.value) {
				lang.focus();
				err1.textContent = 'Please choose a language.';
				return;
			}
			err1.hidden = true;
			step = 1;
			document.getElementById('submit1').hidden = true;
			document.getElementById('submit2').hidden = false;
			if (document.activeElement) document.activeElement.blur();
			document.getElementById('step1').classList.remove('hide');
			smoothScroll(document.getElementById('step1'));
			waiting = true;
			setTimeout(function() {
				waiting = document.getElementById('submit2').disabled = false;
			}, 8000);
			findDups();
			findTags();
			document.getElementById('titlehelp').classList.add('hide');
		} else if (step == 1) {
			step = 2;
			document.getElementById('submit2').hidden = true;
			document.getElementById('submit3').hidden = false;
			document.getElementById('step2').classList.remove('hide');
			smoothScroll(document.getElementById('step2'));
			description.required = question.required = true;
			question.pattern = "[^\\?]{11,}\\?";
			setTimeout(function() {
				description.focus();
			}, 400);
			document.getElementById('explainhelp').classList.remove('hide');
		} else if (step == 2) {
			if (description.value.length &lt; 144) {
				description.focus();
				err3.textContent = 'Question description must be at least 144 characters long. Could you add more detail?';
				return;
			}
			if (question.value.length &lt; 12) {
				question.focus();
				err3.textContent = 'Core question must be at least 12 characters long.';
				return;
			}
			if (question.value.lastIndexOf('?') != question.value.length - 1) {
				question.focus();
				err3.textContent = 'A question must end in a question mark.';
				return;
			}
			if (question.value.length > 144) {
				question.focus();
				err3.textContent = 'Core question must be at most 144 characters long.';
				return;
			}
			err3.hidden = true;
			step = 3;
			document.getElementById('submit3').hidden = true;
			document.getElementById('submit4').hidden = false;
			document.getElementById('step3').classList.remove('hide');
			smoothScroll(document.getElementById('step3'));
			code.required = true;
			setTimeout(function() {
				code.focus();
			}, 400);
			document.getElementById('codehelp').classList.remove('hide');
			document.getElementById('explainhelp').classList.add('hide');
		} else if (step == 3) {
			step = 4;
			document.getElementById('submit4').hidden = true;
			document.getElementById('step4').classList.remove('hide');
			smoothScroll(document.getElementById('step4'));
			document.getElementById('codehelp').classList.add('hide');
		}
	};
	tags.onchange = function() {
		setTimeout(function() {
			var arr = [],
				els = tags.querySelectorAll(':checked');
			for (var i = 0; i &lt; els.length; i++) {
				arr.push(els[i].id.substr(3));
			}
			document.getElementById('tags-input').value = arr.join();
		}, 0);
	};
	document.getElementById('step4').onchange = function() {
		document.getElementById('showpreview').disabled = !document.getElementById('types').querySelector(':checked') || !tags.querySelector(':checked');
	};
	document.getElementById('showpreview').onclick = function(e) {
		e.preventDefault();
		var preview = document.getElementById('preview'), fc;
		while (fc = preview.firstChild) preview.removeChild(fc);
		var h1 = document.createElement('h1');
		h1.appendChild(document.createTextNode(lang.value + ': ' + title.value + ' '));
		var close = document.createElement('small');
		close.appendChild(document.createTextNode('✕'));
		close.onclick = function() {
			preview.hidden = true;
		};
		h1.appendChild(close);
		preview.appendChild(h1);
		var body = document.createElement('div');
		body.innerHTML = markdown(description.value)
			+ (code.value ? '&lt;code class="blk">' + html(code.value) + '&lt;/code>' : '')
			+ '&lt;p>&lt;strong>' + inlineMarkdown(question.value) + '&lt;/strong>&lt;/p>';
		preview.appendChild(body);
		var submit = document.createElement('button');
		submit.appendChild(document.createTextNode('Post Question'));
		submit.id = 'submit';
		submit.onclick = function() {
			this.classList.add('working');
			request('/api/question/add', function(res) {
				if (res.substr(0, 7) == 'Error: ') alert(res);
				else if (res.substr(0, 10) == 'Location: ') location.href = res.substr(10);
				else alert('Unknown error. Response was: ' + res);
			},
				'title=' + encodeURIComponent(title.value) +
				'&amp;lang=' + encodeURIComponent(lang.value) +
				'&amp;description=' + encodeURIComponent(description.value) +
				'&amp;question=' + encodeURIComponent(question.value) +
				'&amp;code=' + encodeURIComponent(code.value) +
				'&amp;type=' + encodeURIComponent(document.getElementById('types').querySelector(':checked').value) +
				'&amp;tags=' + encodeURIComponent(document.getElementById('tags-input').value) +
				'&amp;gr=' + encodeURIComponent(document.getElementById('gr').value) +
				'&amp;self=' + encodeURIComponent(document.getElementById('self').value) +
				'&amp;bounty=' + encodeURIComponent(document.getElementById('bounty').value)
			);
		};
		preview.appendChild(submit);
		preview.hidden = false;
		document.body.classList.add('tint');
		e.stopPropagation();
	};
	document.getElementById('preview').addEventListener('click', function(e) {
		e.stopPropagation();
	});
	addEventListener('click', function() {
		document.getElementById('preview').hidden = true;
		document.body.classList.remove('tint');
	});
</script>